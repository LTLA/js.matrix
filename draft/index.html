<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>js to wasm array</title>
  </head>
  <body>

    <script type="text/javascript">
      function getRandomArbitrary() {
        return Math.random();
      }

      var Module = {
        onRuntimeInitialized: function() {
          // size of array
          const n = 1000;

          // still doesn't work
          // const test = new Float64Array(n);
          // test.set(test.map(() => getRandomArbitrary()));

          // let buffer = Module._malloc(test.length * test.BYTES_PER_ELEMENT);
          // Module.HEAPF64.set(test, buffer >> 2);

          // var nrow = 50, ncol = 20;
          // var instance = new Module.NumericMatrix(nrow, ncol, test.byteOffset);
          // console.log('Matrix dimensions: ' + instance.nrow() + ' ' + instance.ncol());

          // const dim = new Float64Array(ncol);

          // instance.column(0, dim.byteOffset);
          // console.log("First matrix entry: " + dim[0]);

          // instance.delete();

          // eventually figured out the Module initialized memory space

          let ptr = Module._malloc(n*8);
          const mat0 = new Float64Array(
            Module.HEAPF64.buffer,
            ptr,
            1000
          );
          console.log("Offset is " + ptr);
          mat0.set(mat0.map(() => getRandomArbitrary()));
          console.log(mat0[0]);

          var nrow = 50, ncol = 20;

          var instance = new Module.NumericMatrix(nrow, ncol, ptr);
          console.log('Matrix dimensions: ' + instance.nrow() + ' ' + instance.ncol());

          var rptr = Module._malloc(8 * ncol);
          const dim = new Float64Array(
            Module.HEAPF64.buffer,
            rptr,
            ncol
          );
          console.log("Offset is " + rptr);
          console.log("Matrix entry before: " + dim[0]);
          instance.row(0, rptr);
          console.log("Matrix entry after: " + dim[0]);

          instance.delete();
        }
      };
    </script>
    <script src="target.js"></script>
  </body>
</html>
